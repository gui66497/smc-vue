!function(s,x,O){"use strict";var g="ht",W=s[g],k=W.Default,C=k.def,l=k.getInternal();W.HistoryManager=function(c){this._histories=[],this.setDataModel(c)},C(W.HistoryManager,x,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var h=this;h._betweenTransaction++,1===h._betweenTransaction&&(h._transactionHistories={})}},endTransaction:function(){if(!this._disabled){var v=this,a=v._histories;if(v._betweenTransaction>0&&v._betweenTransaction--,0===v._betweenTransaction){if(v._transactionHistories){var l=[];for(var K in v._transactionHistories)l.push(v._transactionHistories[K]);l.length&&(a=a.slice(0,v._historyIndex+1),a.push(l),a.length>v._maxHistoryCount&&(a=a.slice(a.length-v._maxHistoryCount)),v.setHistories(a),v.setHistoryIndex(a.length-1,!0))}delete v._transactionHistories}}},setDataModel:function(L){var z=this,I=z._dataModel;I!==L&&(I&&(delete I._historyManager,I.ump(z.handleDataModelPropertyChange,z),I.umm(z.$5p,z),I.umd(z.$6p,z),I.removeHierarchyChangeListener(z.handleHierarchyChange,z),I.removeIndexChangeListener(z.handleIndexChange,z)),z._dataModel=L,L&&(L._historyManager=z,L.mp(z.handleDataModelPropertyChange,z),L.mm(z.$5p,z),L.md(z.$6p,z),L.addHierarchyChangeListener(z.handleHierarchyChange,z),L.addIndexChangeListener(z.handleIndexChange,z)),z.fp("dataModel",I,L),z.clear())},setHistoryIndex:function(g,N){var G=this,R=G._historyIndex,_=G._histories.length;if(-1>g?g=-1:g>=_&&(g=_-1),R!==g){if(!N){var v=g-R;v>0?G.$2p(v):0>v&&G.$1p(-v)}G._historyIndex=g,G.fp("historyIndex",R,g),G.dataModel&&G.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(u){var b=this,U=b._histories,t=b._maxHistoryCount;(!u||0>=u)&&(u=10),t!==u&&(b._maxHistoryCount=u,b.fp("maxHistoryCount",t,u),U.length>u&&b.clear())},cloneValue:function(w){return W.Default.clone(w)},isPropertyUndoable:function(w){return w&&!this.ignoredPropertyMap[w]},isDataModelPropertyUndoable:function(i){return i&&!this.ignoreDataModelPropertyMap[i]},$5p:function(F){this.handleChange(F,F.kind)},$6p:function(X){this.handleChange(X,"property")},handleHierarchyChange:function(m){this.handleChange(m,"hierarchy")},handleIndexChange:function(e){this.handleChange(e,"index")},handleDataModelPropertyChange:function(Y){this.handleChange(Y,"dataModelProperty")},toChildrenInfo:function(Z){var L={};return L.data=Z,L.children=[],Z.eachChild(function(X){L.children.push(this.toChildrenInfo(X))},this),L},restoreChildren:function(T){var C=T.data;T.children.forEach(function(s){var M=s.data;M.getParent()!==C&&C.addChild(M),this._dataModel.contains(M)||this._dataModel.add(M),this.restoreChildren(s)},this)},handleChange:function(A,j){var t=this;if(!(t._disabled||t._isUndoRedoing||k.loadingRefGraph)){var q,C=(t._histories,A.data),L=A.property;if(!C||!(C._refGraph||C instanceof W.RefGraph)){if("property"===j)t.isPropertyUndoable(L,C)&&(q={kind:j,data:C,property:L,oldValue:t.cloneValue(A.oldValue,C,L),newValue:t.cloneValue(A.newValue,C,L),event:A});else if("hierarchy"===j||"index"===j)q={kind:j,data:C,oldIndex:A.oldIndex,newIndex:A.newIndex,event:A};else if("clear"===j)q={kind:j,json:A.json,event:A};else if("add"===j){if(q={kind:j,data:C,event:A,childrenInfo:this.toChildrenInfo(C),parent:C.getParent()},q.parent){var r=t._dataModel.getSiblings(C);q.siblingsIndex=r.indexOf(C)}C instanceof W.Node&&(q.host=C.getHost(),q.attaches=C.getAttaches()?C.getAttaches().toArray():O),C instanceof W.Edge&&(q.source=C.getSource(),q.target=C.getTarget())}else"remove"===j?q={kind:j,data:C,event:A}:"dataModelProperty"===j&&t.isDataModelPropertyUndoable(L,C)&&(q={kind:j,property:L,oldValue:t.cloneValue(A.oldValue,C,L),newValue:t.cloneValue(A.newValue,C,L),event:A});t.addHistory(q)}}},addHistory:function($){var h=this;if($)if(h._betweenTransaction){var y=($.data?$.data._id:0)+"_"+$.kind+"_"+$.property;if("property"===$.kind||"dataModelProperty"===$.kind){var Z=h._transactionHistories[y];Z&&($.oldValue=Z.oldValue)}h._transactionHistories[y]=$}else{var G=h._histories;G=G.slice(0,h._historyIndex+1),G.push([$]),G.length>h._maxHistoryCount&&(G=G.slice(G.length-h._maxHistoryCount)),h.setHistories(G),h.setHistoryIndex(G.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(c){(!c||0>=c)&&(c=1),this.setHistoryIndex(this._historyIndex-c)},$1p:function(e){if(this.canUndo()){var y,C=this,R=C._dataModel,Y=C._histories,i=C._historyIndex,m=0;for(C._isUndoRedoing=!0,k.setIsolating(!0);e>0;){if(i>=0&&i<Y.length){m++,y=Y[i],i--;for(var f=y.length-1;f>=0;f--){var u=y[f],M=u.kind,K=u.data,h=u.property,$=u.event,U=this.cloneValue(u.oldValue,K,h);if(u.undo)u.undo();else if("add"===M)R.remove(K,{keepChildren:!0});else if("remove"===M)R.contains(K)||R.add(K,$.rootsIndex,$.datasIndex);else if("clear"===M)R.deserialize(k.clone(u.json));else if("property"===M)if("parent"===h)U?U.addChild(K,$.oldIndex):(K.setParent(U),$.oldIndex>=0&&R.moveTo(K,$.oldIndex));else{var j=null;0===h.indexOf("a:")?(j="attr",h=h.replace("a:","")):0===h.indexOf("s:")?(j="style",h=h.replace("s:","")):0===h.indexOf("f:")&&(j="field",h=h.replace("f:","")),l.setPropertyValue(K,j,h,U)}else if("dataModelProperty"===M){var j=null;0===h.indexOf("a:")?(j="attr",h=h.replace("a:","")):0===h.indexOf("s:")?(j="style",h=h.replace("s:","")):0===h.indexOf("f:")&&(j="field",h=h.replace("f:","")),l.setPropertyValue(R,j,h,U)}else"hierarchy"===M?R.moveTo(K,u.oldIndex):"index"===M&&R.moveToIndex(K,u.oldIndex)}}e--}k.setIsolating(!1),delete C._isUndoRedoing,C.afterUndo(m)}},afterUndo:function(){},redo:function(G){(!G||0>=G)&&(G=1),this.setHistoryIndex(this._historyIndex+G)},$2p:function(V){if(this.canRedo()){var A,B=this,o=B._dataModel,M=B._histories,d=B._historyIndex,x=0;for(B._isUndoRedoing=!0,k.setIsolating(!0);V>0;){if(d>=-1&&d<M.length-1){x++,d++,A=M[d];for(var t=0;t<A.length;t++){var Y=A[t],I=Y.kind,D=Y.data,_=Y.property,z=Y.event,R=this.cloneValue(Y.newValue,D,_);if(Y.redo)Y.redo();else if("add"===I)Y.parent&&!D.getParent()&&Y.parent.addChild(D,Y.siblingsIndex),o.contains(D)||o.add(D,z.rootsIndex,z.datasIndex),this.restoreChildren(Y.childrenInfo),D instanceof W.Node&&(D.setHost(Y.host),Y.attaches&&Y.attaches.forEach(function(c){c.setHost(D)})),D instanceof W.Edge&&(D.setSource(Y.source),D.setTarget(Y.target));else if("remove"===I)o.remove(D);else if("clear"===I)o.clear();else if("property"===I)if("parent"===_)R?R.addChild(D,z.newIndex):(D.setParent(R),z.newIndex>=0&&o.moveTo(D,z.newIndex));else{var N=null;0===_.indexOf("a:")?(N="attr",_=_.replace("a:","")):0===_.indexOf("s:")?(N="style",_=_.replace("s:","")):0===_.indexOf("f:")&&(N="field",_=_.replace("f:","")),l.setPropertyValue(D,N,_,R)}else if("dataModelProperty"===I){var N=null;0===_.indexOf("a:")?(N="attr",_=_.replace("a:","")):0===_.indexOf("s:")?(N="style",_=_.replace("s:","")):0===_.indexOf("f:")&&(N="field",_=_.replace("f:","")),l.setPropertyValue(o,N,_,R)}else"hierarchy"===I?o.moveTo(D,Y.newIndex):"index"===I&&o.moveToIndex(D,Y.newIndex)}}V--}k.setIsolating(!1),delete B._isUndoRedoing,this.afterRedo(x)}},afterRedo:function(){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);